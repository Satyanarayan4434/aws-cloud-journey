#!/bin/bash
set -e

# Install Apache (yum or dnf safe)
if command -v dnf >/dev/null 2>&1; then
  dnf update -y
  dnf install -y httpd
else
  yum update -y
  yum install -y httpd
fi

# Start Apache
systemctl start httpd
systemctl enable httpd

# Get IMDSv2 token
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" \
  -H "X-aws-ec2-metadata-token-ttl-seconds: 21600" -s)

# Fetch metadata
INSTANCE_ID=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/instance-id)

AZ=$(curl -s -H "X-aws-ec2-metadata-token: $TOKEN" \
  http://169.254.169.254/latest/meta-data/placement/availability-zone)

HOSTNAME=$(hostname)

# Create HTML using echo (light theme)
echo '<!DOCTYPE html>' > /var/www/html/index.html
echo '<html>' >> /var/www/html/index.html
echo '<head>' >> /var/www/html/index.html
echo '  <title>AWS Server Dashboard</title>' >> /var/www/html/index.html
echo '  <style>' >> /var/www/html/index.html
echo '    body {' >> /var/www/html/index.html
echo '      font-family: Segoe UI, Arial, sans-serif;' >> /var/www/html/index.html
echo '      background: #f8fafc;' >> /var/www/html/index.html
echo '      color: #0f172a;' >> /var/www/html/index.html
echo '      padding: 50px;' >> /var/www/html/index.html
echo '    }' >> /var/www/html/index.html
echo '    .box {' >> /var/www/html/index.html
echo '      max-width: 600px;' >> /var/www/html/index.html
echo '      margin: auto;' >> /var/www/html/index.html
echo '      background: #ffffff;' >> /var/www/html/index.html
echo '      padding: 30px;' >> /var/www/html/index.html
echo '      border-radius: 12px;' >> /var/www/html/index.html
echo '      box-shadow: 0 10px 25px rgba(0,0,0,0.08);' >> /var/www/html/index.html
echo '    }' >> /var/www/html/index.html
echo '    h1 {' >> /var/www/html/index.html
echo '      color: #1e40af;' >> /var/www/html/index.html
echo '      margin-bottom: 20px;' >> /var/www/html/index.html
echo '    }' >> /var/www/html/index.html
echo '    .item {' >> /var/www/html/index.html
echo '      margin: 12px 0;' >> /var/www/html/index.html
echo '      font-size: 17px;' >> /var/www/html/index.html
echo '      padding-bottom: 8px;' >> /var/www/html/index.html
echo '      border-bottom: 1px solid #e5e7eb;' >> /var/www/html/index.html
echo '    }' >> /var/www/html/index.html
echo '  </style>' >> /var/www/html/index.html
echo '</head>' >> /var/www/html/index.html
echo '<body>' >> /var/www/html/index.html
echo '  <div class="box">' >> /var/www/html/index.html
echo '    <h1>AWS EC2 Instance Information</h1>' >> /var/www/html/index.html
echo "    <div class='item'>Hostname: <b>$HOSTNAME</b></div>" >> /var/www/html/index.html
echo "    <div class='item'>Instance ID: <b>$INSTANCE_ID</b></div>" >> /var/www/html/index.html
echo "    <div class='item'>Availability Zone: <b>$AZ</b></div>" >> /var/www/html/index.html
echo "    <div class='item'>Status: <b style='color:#16a34a;'>Running</b></div>" >> /var/www/html/index.html
echo '  </div>' >> /var/www/html/index.html
echo '</body>' >> /var/www/html/index.html
echo '</html>' >> /var/www/html/index.html
